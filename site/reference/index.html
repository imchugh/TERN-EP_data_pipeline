
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../visualisation/">
      
      
        <link rel="next" href="../metadata/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.26">
    
    
      
        <title>data_merging - TERN EP Data Pipeline</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#netcdf-file-builders" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="TERN EP Data Pipeline" class="md-header__button md-logo" aria-label="TERN EP Data Pipeline" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TERN EP Data Pipeline
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              data_merging
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="TERN EP Data Pipeline" class="md-nav__button md-logo" aria-label="TERN EP Data Pipeline" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    TERN EP Data Pipeline
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Main docs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../network_architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Network architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../visualisation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data visualisation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Code
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Code
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    data_merging
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    data_merging
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#nc_builders.ds_builder" class="md-nav__link">
    <span class="md-ellipsis">
      ds_builder
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.L1DataBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      L1DataBuilder
    </span>
  </a>
  
    <nav class="md-nav" aria-label="L1DataBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.L1DataBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.L1DataBuilder.build_xarray_dataset_by_slice" class="md-nav__link">
    <span class="md-ellipsis">
      build_xarray_dataset_by_slice
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.L1DataBuilder.build_xarray_dataset_by_year" class="md-nav__link">
    <span class="md-ellipsis">
      build_xarray_dataset_by_year
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.L1DataBuilder.build_xarray_dataset_complete" class="md-nav__link">
    <span class="md-ellipsis">
      build_xarray_dataset_complete
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.NCConverter" class="md-nav__link">
    <span class="md-ellipsis">
      NCConverter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NCConverter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.NCConverter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.NCConverter.make_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      make_dataframe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.NCConverter.make_headers" class="md-nav__link">
    <span class="md-ellipsis">
      make_headers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.NCConverter.write_to_TOA5" class="md-nav__link">
    <span class="md-ellipsis">
      write_to_TOA5
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.append_to_current_nc_file" class="md-nav__link">
    <span class="md-ellipsis">
      append_to_current_nc_file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.append_to_nc" class="md-nav__link">
    <span class="md-ellipsis">
      append_to_nc
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.make_nc_file" class="md-nav__link">
    <span class="md-ellipsis">
      make_nc_file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.make_nc_year_file" class="md-nav__link">
    <span class="md-ellipsis">
      make_nc_year_file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.merge_data_by_manager" class="md-nav__link">
    <span class="md-ellipsis">
      merge_data_by_manager
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../metadata/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    metadata_handling
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#nc_builders.ds_builder" class="md-nav__link">
    <span class="md-ellipsis">
      ds_builder
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.L1DataBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      L1DataBuilder
    </span>
  </a>
  
    <nav class="md-nav" aria-label="L1DataBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.L1DataBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.L1DataBuilder.build_xarray_dataset_by_slice" class="md-nav__link">
    <span class="md-ellipsis">
      build_xarray_dataset_by_slice
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.L1DataBuilder.build_xarray_dataset_by_year" class="md-nav__link">
    <span class="md-ellipsis">
      build_xarray_dataset_by_year
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.L1DataBuilder.build_xarray_dataset_complete" class="md-nav__link">
    <span class="md-ellipsis">
      build_xarray_dataset_complete
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.NCConverter" class="md-nav__link">
    <span class="md-ellipsis">
      NCConverter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NCConverter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.NCConverter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.NCConverter.make_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      make_dataframe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.NCConverter.make_headers" class="md-nav__link">
    <span class="md-ellipsis">
      make_headers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.NCConverter.write_to_TOA5" class="md-nav__link">
    <span class="md-ellipsis">
      write_to_TOA5
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.append_to_current_nc_file" class="md-nav__link">
    <span class="md-ellipsis">
      append_to_current_nc_file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.append_to_nc" class="md-nav__link">
    <span class="md-ellipsis">
      append_to_nc
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.make_nc_file" class="md-nav__link">
    <span class="md-ellipsis">
      make_nc_file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.make_nc_year_file" class="md-nav__link">
    <span class="md-ellipsis">
      make_nc_year_file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nc_builders.ds_builder.merge_data_by_manager" class="md-nav__link">
    <span class="md-ellipsis">
      merge_data_by_manager
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<p>This part of the project documentation focuses on
an <strong>information-oriented</strong> approach. Use it as a
reference for the technical implementation of the
<code>calculator</code> project code.</p>
<h1 id="netcdf-file-builders">NetCDF file builders</h1>


<div class="doc doc-object doc-module">



<a id="nc_builders.ds_builder"></a>
    <div class="doc doc-contents first">

      <p>Created on Thu May 16 16:25:29 2024</p>
<p>@author: imchugh</p>
<p>This module is used to merge data (from multiple raw data file sources) and
metadata (from configuration files and TERN DSA database) into xarray datasets
and netcdf files (only L1 so far).</p>


<details class="module-classes" open>
  <summary>Module classes</summary>
  <ul>
<li>L1DataBuilder - builds an xarray dataset with data and metadata required
to generate L1 files.</li>
<li>NCConverter - used to extract data from an existing .nc file and push
back out to Campbell Scientific TOA5 format data file.</li>
</ul>
</details>

<details class="module-functions" open>
  <summary>Module functions</summary>
  <ul>
<li>make_nc_file - generates the xarray dataset and writes out to nc file.</li>
<li>make_nc_year_file - as above, but confined to a single data year.</li>
<li>append_to_current_nc_file - checks for a current-year .nc file - appends
if it exists, generates it if it doesn't.</li>
<li>append_to_nc - generic append function where existing file is passed as
arg.</li>
</ul>
</details>


  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="nc_builders.ds_builder.L1DataBuilder" class="doc doc-heading">
            <code>L1DataBuilder</code>


</h2>


    <div class="doc doc-contents ">


              <details class="quote">
                <summary>Source code in <code>code\nc_builders\ds_builder.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">L1DataBuilder</span><span class="p">():</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">md_mngr</span><span class="p">:</span> <span class="n">mh</span><span class="o">.</span><span class="n">MetaDataManager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">concat_files</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the data and metadata.</span>

<span class="sd">        Args:</span>
<span class="sd">            site: name of site.</span>
<span class="sd">            md_mngr (optional): existing MetaDataManager. Defaults to None.</span>
<span class="sd">            concat_files (optional): If true, concatenate the raw data files</span>
<span class="sd">            and historical backups. If not, not. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">site</span>
        <span class="k">if</span> <span class="n">md_mngr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">md_mngr</span> <span class="o">=</span> <span class="n">mh</span><span class="o">.</span><span class="n">MetaDataManager</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md_mngr</span> <span class="o">=</span> <span class="n">md_mngr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">merge_data_by_manager</span><span class="p">(</span>
            <span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">,</span> <span class="n">md_mngr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">md_mngr</span><span class="p">,</span> <span class="n">concat_files</span><span class="o">=</span><span class="n">concat_files</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_years</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_site_global_attrs</span><span class="p">()</span>
    <span class="c1">#--------------------------------------------------------------------------</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_get_site_global_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combine default and site-specific info to create preliminary global</span>
<span class="sd">        attrs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TYPE: DESCRIPTION.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">global_attrs</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_global_configs</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;nc_generic_attrs&#39;</span><span class="p">)</span>
        <span class="n">new_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;metadata_link&#39;</span><span class="p">:</span>
                <span class="n">global_attrs</span><span class="p">[</span><span class="s1">&#39;metadata_link&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;site&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">),</span>
            <span class="s1">&#39;site_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span>
            <span class="p">}</span>
        <span class="n">global_attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_dict</span><span class="p">)</span>

        <span class="n">site_specific_attrs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">md_mngr</span><span class="o">.</span><span class="n">site_details</span>
            <span class="p">[</span><span class="n">SITE_DETAIL_SUBSET</span><span class="p">]</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">SITE_DETAIL_ALIASES</span><span class="p">)</span>
            <span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">global_attrs</span> <span class="o">|</span> <span class="n">site_specific_attrs</span>
    <span class="c1">#--------------------------------------------------------------------------</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">build_xarray_dataset_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build an xarray dataset constructed from all of the raw data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The dataset.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_xarray_dataset</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="c1">#--------------------------------------------------------------------------</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">build_xarray_dataset_by_slice</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span> <span class="o">|</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">end_date</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span> <span class="o">|</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build an xarray dataset constructed from a discrete time slice.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_date (optional): the start date for the data. If None,</span>
<span class="sd">            starts at the beginning of the merged dataset. Defaults to None.</span>
<span class="sd">            end_date (optional): the end date for the data. If None,</span>
<span class="sd">            ends at the end of the merged dataset. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The dataset.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">start_date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">end_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_xarray_dataset_complete</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">start_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_xarray_dataset</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span> <span class="n">end_date</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">end_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_xarray_dataset</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_date</span><span class="p">:]</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_xarray_dataset</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_date</span><span class="p">:</span> <span class="n">end_date</span><span class="p">]</span>
            <span class="p">)</span>
    <span class="c1">#--------------------------------------------------------------------------</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">build_xarray_dataset_by_year</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build an xarray dataset constructed from a given year.</span>

<span class="sd">        Args:</span>
<span class="sd">            year: the data year to return.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The dataset.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">year</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_years</span><span class="p">:</span>
            <span class="n">years</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_years</span><span class="p">])</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Data year is not available (available years: </span><span class="si">{</span><span class="n">years</span><span class="si">}</span><span class="s1">)&#39;</span>
                <span class="p">)</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_year_bounds</span><span class="p">(</span>
            <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span>
            <span class="n">time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_attrs</span><span class="p">[</span><span class="s1">&#39;time_step&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_xarray_dataset</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="p">)</span>
    <span class="c1">#--------------------------------------------------------------------------</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_get_year_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">time_step</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>


<span class="sd">        Args:</span>
<span class="sd">            year (int): DESCRIPTION.</span>
<span class="sd">            time_step (int): DESCRIPTION.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: DESCRIPTION.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span>
                <span class="p">(</span>
                <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">time_step</span><span class="p">))</span>
                <span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">TIME_FORMAT</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">TIME_FORMAT</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="c1">#--------------------------------------------------------------------------</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_build_xarray_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the dataframe to an xarray dataset and apply global attributes.</span>

<span class="sd">        Args:</span>
<span class="sd">            df: the dataframe to convert to xr dataset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ds: xarray dataset.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create xarray dataset</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">latitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_attrs</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span>
                <span class="n">longitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_attrs</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="c1"># Assign global and variable attrs and flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_global_attrs</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_dim_attrs</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_dim_encoding</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_variable_attrs</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_crs_var</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_variable_flags</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ds</span>
    <span class="c1">#--------------------------------------------------------------------------</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_assign_global_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Augment global attributes.</span>

<span class="sd">        Args:</span>
<span class="sd">            df: pandas dataframe containing merged data.</span>
<span class="sd">            md_mngr: VariableManager class used to access variable attributes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict containing global attributes.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get time info to add to global attrs (note that year is lagged</span>
        <span class="c1"># by one time interval because the timestamps are named for the END of</span>
        <span class="c1"># the measurement period)</span>
        <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">TIME_FORMAT</span><span class="p">)</span>
        <span class="n">year_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span>
                <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">md_mngr</span><span class="o">.</span><span class="n">site_details</span><span class="o">.</span><span class="n">time_step</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="o">.</span><span class="n">year</span>
            <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="c1"># pd.to_datetime(ds.time.values).year.unique()</span>
        <span class="n">year_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">year_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">year_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; for the calendar year </span><span class="si">{</span><span class="n">year_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">title_str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Flux tower data set from the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="si">}</span><span class="s1"> site&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">year_str</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">md_mngr</span><span class="o">.</span><span class="n">irga_type</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

        <span class="c1"># Get current time info for run</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">this_year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y&#39;</span><span class="p">)</span>
        <span class="n">this_month</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b&#39;</span><span class="p">)</span>

        <span class="c1"># Assign attrs</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_attrs</span> <span class="o">|</span>
            <span class="p">{</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title_str</span><span class="p">,</span>
                <span class="s1">&#39;date_created&#39;</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">TIME_FORMAT</span><span class="p">),</span>
                <span class="s1">&#39;nc_nrecs&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="p">),</span>
                <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">this_month</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">this_year</span><span class="si">}</span><span class="s1"> processing&#39;</span><span class="p">,</span>
                <span class="s1">&#39;time_coverage_start&#39;</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s1">&#39;time_coverage_end&#39;</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s1">&#39;irga_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_mngr</span><span class="o">.</span><span class="n">irga_type</span><span class="p">,</span>
                <span class="s1">&#39;sonic_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_mngr</span><span class="o">.</span><span class="n">sonic_type</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="c1">#--------------------------------------------------------------------------</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_assign_dim_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply dimension attributes (time, lattitude and longitude).</span>

<span class="sd">        Args:</span>
<span class="sd">            ds: xarray dataset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dim_attrs</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_global_configs</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;nc_dim_attrs&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">ds</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dim_attrs</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
    <span class="c1">#--------------------------------------------------------------------------</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_set_dim_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply (so far only) time dimension encoding.</span>

<span class="sd">        Args:</span>
<span class="sd">            ds: xarray dataset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">encoding</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;days since 1800-01-01 00:00:00.0&#39;</span>
    <span class="c1">#--------------------------------------------------------------------------</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_assign_variable_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign the variable attributes to the existing dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            ds: xarray dataset.</span>
<span class="sd">            md_mngr: VariableManager class used to access variable attributes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">var_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_list</span><span class="p">:</span>
            <span class="n">ds</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">md_mngr</span><span class="o">.</span><span class="n">get_variable_attributes</span><span class="p">(</span><span class="n">variable</span><span class="o">=</span><span class="n">var</span><span class="p">)</span>
                <span class="p">[</span><span class="n">VAR_METADATA_SUBSET</span><span class="p">]</span>
                <span class="p">)</span>
    <span class="c1">#--------------------------------------------------------------------------</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_assign_crs_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign coordinate reference system variable.</span>

<span class="sd">        Args:</span>
<span class="sd">            ds: xarray dataset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dim_attrs</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_global_configs</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;nc_dim_attrs&#39;</span><span class="p">)</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="n">dim_attrs</span><span class="p">[</span><span class="s1">&#39;coordinate_reference_system&#39;</span><span class="p">]</span>
            <span class="p">)</span>
    <span class="c1">#--------------------------------------------------------------------------</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_assign_variable_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign the variable QC flags to the existing dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            ds: xarray dataset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">var_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_list</span><span class="p">:</span>
            <span class="n">ds</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">_QCFlag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">],</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">var</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                <span class="p">{</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">QC flag&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">}</span>
                <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="nc_builders.ds_builder.L1DataBuilder.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">md_mngr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">concat_files</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Get the data and metadata.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>site</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of site.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>md_mngr</code></td>
            <td>
                  <code>optional</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>existing MetaDataManager. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>concat_files</code></td>
            <td>
                  <code>optional</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If true, concatenate the raw data files</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>code\nc_builders\ds_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">md_mngr</span><span class="p">:</span> <span class="n">mh</span><span class="o">.</span><span class="n">MetaDataManager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">concat_files</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the data and metadata.</span>

<span class="sd">    Args:</span>
<span class="sd">        site: name of site.</span>
<span class="sd">        md_mngr (optional): existing MetaDataManager. Defaults to None.</span>
<span class="sd">        concat_files (optional): If true, concatenate the raw data files</span>
<span class="sd">        and historical backups. If not, not. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">site</span>
    <span class="k">if</span> <span class="n">md_mngr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">md_mngr</span> <span class="o">=</span> <span class="n">mh</span><span class="o">.</span><span class="n">MetaDataManager</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">md_mngr</span> <span class="o">=</span> <span class="n">md_mngr</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">merge_data_by_manager</span><span class="p">(</span>
        <span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">,</span> <span class="n">md_mngr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">md_mngr</span><span class="p">,</span> <span class="n">concat_files</span><span class="o">=</span><span class="n">concat_files</span>
        <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data_years</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">global_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_site_global_attrs</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="nc_builders.ds_builder.L1DataBuilder.build_xarray_dataset_by_slice" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_xarray_dataset_by_slice</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Build an xarray dataset constructed from a discrete time slice.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>start_date</code></td>
            <td>
                  <code>optional</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the start date for the data. If None,</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>end_date</code></td>
            <td>
                  <code>optional</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the end date for the data. If None,</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="xarray.Dataset">Dataset</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dataset.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>code\nc_builders\ds_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">build_xarray_dataset_by_slice</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span> <span class="o">|</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span> <span class="o">|</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build an xarray dataset constructed from a discrete time slice.</span>

<span class="sd">    Args:</span>
<span class="sd">        start_date (optional): the start date for the data. If None,</span>
<span class="sd">        starts at the beginning of the merged dataset. Defaults to None.</span>
<span class="sd">        end_date (optional): the end date for the data. If None,</span>
<span class="sd">        ends at the end of the merged dataset. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The dataset.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">start_date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">end_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_xarray_dataset_complete</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">start_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_xarray_dataset</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span> <span class="n">end_date</span><span class="p">]</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">end_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_xarray_dataset</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_date</span><span class="p">:]</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_xarray_dataset</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_date</span><span class="p">:</span> <span class="n">end_date</span><span class="p">]</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="nc_builders.ds_builder.L1DataBuilder.build_xarray_dataset_by_year" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_xarray_dataset_by_year</span><span class="p">(</span><span class="n">year</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Build an xarray dataset constructed from a given year.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>year</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the data year to return.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="xarray.Dataset">Dataset</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dataset.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>code\nc_builders\ds_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">build_xarray_dataset_by_year</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build an xarray dataset constructed from a given year.</span>

<span class="sd">    Args:</span>
<span class="sd">        year: the data year to return.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The dataset.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">year</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_years</span><span class="p">:</span>
        <span class="n">years</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_years</span><span class="p">])</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Data year is not available (available years: </span><span class="si">{</span><span class="n">years</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="p">)</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_year_bounds</span><span class="p">(</span>
        <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span>
        <span class="n">time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_attrs</span><span class="p">[</span><span class="s1">&#39;time_step&#39;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_xarray_dataset</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="nc_builders.ds_builder.L1DataBuilder.build_xarray_dataset_complete" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_xarray_dataset_complete</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Build an xarray dataset constructed from all of the raw data.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="xarray.Dataset">Dataset</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dataset.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>code\nc_builders\ds_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">build_xarray_dataset_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build an xarray dataset constructed from all of the raw data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The dataset.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_xarray_dataset</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="nc_builders.ds_builder.NCConverter" class="doc doc-heading">
            <code>NCConverter</code>


</h2>


    <div class="doc doc-contents ">


      <p>Class to allow conversion of data from NetCDF format back to a TOA5-like file.
This is intended to replace the current functionality for production of the
RTMC datasets.</p>

              <details class="quote">
                <summary>Source code in <code>code\nc_builders\ds_builder.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">NCConverter</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to allow conversion of data from NetCDF format back to a TOA5-like file.</span>
<span class="sd">    This is intended to replace the current functionality for production of the</span>
<span class="sd">    RTMC datasets.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nc_file</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the NetCDF file as xarray dataset, and set labels to keep / drop.</span>

<span class="sd">        Args:</span>
<span class="sd">            nc_file: Absolute path to NetCDF file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None.</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">nc_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels_to_drop</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="k">if</span> <span class="s1">&#39;QCFlag&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels_to_keep</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_to_drop</span>
            <span class="p">]</span>
    <span class="c1">#--------------------------------------------------------------------------</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">make_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Strip back the dataset to the minimum required for the dataframe.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dataframe.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span>
            <span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
            <span class="o">.</span><span class="n">droplevel</span><span class="p">([</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_to_drop</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;DATETIME&#39;</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="c1">#--------------------------------------------------------------------------</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">make_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the header dataframe required for the TOA5 conversion.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dataframe.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;statistic_type&#39;</span><span class="p">:</span>
                        <span class="n">STATISTIC_ALIASES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;statistic_type&#39;</span><span class="p">]]</span>
                    <span class="p">}</span>
                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_to_keep</span>
                <span class="p">],</span>
            <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_to_keep</span>
            <span class="p">)</span>
    <span class="c1">#--------------------------------------------------------------------------</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">write_to_TOA5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>


<span class="sd">        Args:</span>
<span class="sd">            file_path (TYPE): DESCRIPTION.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">reformat_headers</span><span class="p">(</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">make_headers</span><span class="p">()</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;statistic_type&#39;</span><span class="p">:</span> <span class="s1">&#39;sampling&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;TOA5&#39;</span>
            <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">reformat_data</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">make_dataframe</span><span class="p">(),</span>
            <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;TOA5&#39;</span>
            <span class="p">)</span>
        <span class="n">io</span><span class="o">.</span><span class="n">write_data_to_file</span><span class="p">(</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">abs_file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
            <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;TOA5&#39;</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="nc_builders.ds_builder.NCConverter.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">nc_file</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Open the NetCDF file as xarray dataset, and set labels to keep / drop.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>nc_file</code></td>
            <td>
                  <code><span title="pathlib.Path">Path</span> | str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Absolute path to NetCDF file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>code\nc_builders\ds_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nc_file</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Open the NetCDF file as xarray dataset, and set labels to keep / drop.</span>

<span class="sd">    Args:</span>
<span class="sd">        nc_file: Absolute path to NetCDF file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None.</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">nc_file</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">labels_to_drop</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="k">if</span> <span class="s1">&#39;QCFlag&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">labels_to_keep</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_to_drop</span>
        <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="nc_builders.ds_builder.NCConverter.make_dataframe" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_dataframe</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Strip back the dataset to the minimum required for the dataframe.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.core.frame.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>code\nc_builders\ds_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Strip back the dataset to the minimum required for the dataframe.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dataframe.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span>
        <span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="o">.</span><span class="n">droplevel</span><span class="p">([</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_to_drop</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;DATETIME&#39;</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="nc_builders.ds_builder.NCConverter.make_headers" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_headers</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Create the header dataframe required for the TOA5 conversion.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.core.frame.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>code\nc_builders\ds_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create the header dataframe required for the TOA5 conversion.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dataframe.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">],</span>
                <span class="s1">&#39;statistic_type&#39;</span><span class="p">:</span>
                    <span class="n">STATISTIC_ALIASES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;statistic_type&#39;</span><span class="p">]]</span>
                <span class="p">}</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_to_keep</span>
            <span class="p">],</span>
        <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_to_keep</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="nc_builders.ds_builder.NCConverter.write_to_TOA5" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_to_TOA5</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>file_path</code></td>
            <td>
                  <code>TYPE</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DESCRIPTION.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>code\nc_builders\ds_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">write_to_TOA5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>


<span class="sd">    Args:</span>
<span class="sd">        file_path (TYPE): DESCRIPTION.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">reformat_headers</span><span class="p">(</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_headers</span><span class="p">()</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;statistic_type&#39;</span><span class="p">:</span> <span class="s1">&#39;sampling&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">),</span>
        <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;TOA5&#39;</span>
        <span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">reformat_data</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">make_dataframe</span><span class="p">(),</span>
        <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;TOA5&#39;</span>
        <span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">write_data_to_file</span><span class="p">(</span>
        <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="n">abs_file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
        <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;TOA5&#39;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="nc_builders.ds_builder.append_to_current_nc_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">append_to_current_nc_file</span><span class="p">(</span><span class="n">site</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Check for current year nc file, and if exists, append. If not, create.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>site</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of site.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>code\nc_builders\ds_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">append_to_current_nc_file</span><span class="p">(</span><span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check for current year nc file, and if exists, append. If not, create.</span>

<span class="sd">    Args:</span>
<span class="sd">        site: name of site.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">md_mngr</span> <span class="o">=</span> <span class="n">mh</span><span class="o">.</span><span class="n">MetaDataManager</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">)</span>
    <span class="n">expected_year</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
    <span class="n">expected_file</span> <span class="o">=</span> <span class="n">md_mngr</span><span class="o">.</span><span class="n">data_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">expected_year</span><span class="si">}</span><span class="s1">_L1.nc&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expected_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">make_nc_year_file</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">expected_year</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">append_to_nc</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">,</span> <span class="n">nc_file</span><span class="o">=</span><span class="n">expected_file</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="nc_builders.ds_builder.append_to_nc" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">append_to_nc</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">nc_file</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Generic append function. Only appends new data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>site</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of site.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>nc_file</code></td>
            <td>
                  <code><span title="pathlib.Path">Path</span> | str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>nc file to which to append data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>code\nc_builders\ds_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">append_to_nc</span><span class="p">(</span><span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nc_file</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic append function. Only appends new data.</span>

<span class="sd">    Args:</span>
<span class="sd">        site: name of site.</span>
<span class="sd">        nc_file: nc file to which to append data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">nc_file</span><span class="p">)</span>
    <span class="n">last_nc_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
    <span class="n">md_mngr</span> <span class="o">=</span> <span class="n">mh</span><span class="o">.</span><span class="n">MetaDataManager</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">)</span>
    <span class="n">last_raw_date</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
        <span class="p">[</span><span class="n">md_mngr</span><span class="o">.</span><span class="n">get_file_attrs</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="s1">&#39;end_date&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">md_mngr</span><span class="o">.</span><span class="n">list_files</span><span class="p">()]</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">last_raw_date</span> <span class="o">&gt;</span> <span class="n">last_nc_date</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No new data to append!&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">data_builder</span> <span class="o">=</span> <span class="n">L1DataBuilder</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">,</span> <span class="n">md_mngr</span><span class="o">=</span><span class="n">md_mngr</span><span class="p">)</span>
    <span class="n">date_iloc</span> <span class="o">=</span> <span class="n">data_builder</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">last_nc_date</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">new_ds</span> <span class="o">=</span> <span class="n">data_builder</span><span class="o">.</span><span class="n">build_xarray_dataset_by_slice</span><span class="p">(</span>
        <span class="n">start_date</span><span class="o">=</span><span class="n">data_builder</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">date_iloc</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ds</span><span class="p">,</span> <span class="n">new_ds</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="s1">&#39;override&#39;</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">combined_ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_coverage_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">combined_ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">TIME_FORMAT</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">combined_ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;nc_nrecs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_ds</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
    <span class="n">combined_ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">nc_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="nc_builders.ds_builder.make_nc_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_nc_file</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">split_by_year</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Merge all data and metadata sources to create a netcdf file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>site</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of site.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>split_by_year</code></td>
            <td>
                  <code>optional</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>write discrete year files. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>code\nc_builders\ds_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_nc_file</span><span class="p">(</span><span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">split_by_year</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge all data and metadata sources to create a netcdf file.</span>

<span class="sd">    Args:</span>
<span class="sd">        site: name of site.</span>
<span class="sd">        split_by_year (optional): write discrete year files. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data_builder</span> <span class="o">=</span> <span class="n">L1DataBuilder</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">,</span> <span class="n">concat_files</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">split_by_year</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">data_builder</span><span class="o">.</span><span class="n">build_xarray_dataset_complete</span><span class="p">()</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">data_builder</span><span class="o">.</span><span class="n">md_mngr</span><span class="o">.</span><span class="n">data_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s1">_L1.nc&#39;</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">data_builder</span><span class="o">.</span><span class="n">data_years</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">data_builder</span><span class="o">.</span><span class="n">build_xarray_dataset_by_year</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">data_builder</span><span class="o">.</span><span class="n">md_mngr</span><span class="o">.</span><span class="n">data_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">_L1.nc&#39;</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="nc_builders.ds_builder.make_nc_year_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_nc_year_file</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Merge all data and metadata sources to create a single year netcdf file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>site</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of site.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>year</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>year to write.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>IndexError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>raised if dataset does not contain passed year.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>code\nc_builders\ds_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_nc_year_file</span><span class="p">(</span><span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge all data and metadata sources to create a single year netcdf file.</span>

<span class="sd">    Args:</span>
<span class="sd">        site: name of site.</span>
<span class="sd">        year: year to write.</span>

<span class="sd">    Raises:</span>
<span class="sd">        IndexError: raised if dataset does not contain passed year.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data_builder</span> <span class="o">=</span> <span class="n">L1DataBuilder</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">,</span> <span class="n">concat_files</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">data_builder</span><span class="o">.</span><span class="n">data_years</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;No data available for current data year!&#39;</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">data_builder</span><span class="o">.</span><span class="n">build_xarray_dataset_by_year</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">)</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">data_builder</span><span class="o">.</span><span class="n">md_mngr</span><span class="o">.</span><span class="n">data_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">_L1.nc&#39;</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="nc_builders.ds_builder.merge_data_by_manager" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">merge_data_by_manager</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">md_mngr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">concat_files</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>site</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DESCRIPTION.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>md_mngr</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="utils.metadata_handlers.MetaDataManager" href="../metadata/#utils.metadata_handlers.MetaDataManager">MetaDataManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DESCRIPTION. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>TYPE</code></td>            <td>
                  <code><span title="pandas.core.frame.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DESCRIPTION.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>code\nc_builders\ds_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">merge_data_by_manager</span><span class="p">(</span>
        <span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">md_mngr</span><span class="p">:</span> <span class="n">mh</span><span class="o">.</span><span class="n">MetaDataManager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">concat_files</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>


<span class="sd">    Args:</span>
<span class="sd">        site (str): DESCRIPTION.</span>
<span class="sd">        md_mngr (mh.MetaDataManager, optional): DESCRIPTION. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        TYPE: DESCRIPTION.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">md_mngr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">md_mngr</span> <span class="o">=</span> <span class="n">mh</span><span class="o">.</span><span class="n">MetaDataManager</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">)</span>
    <span class="n">merge_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">file</span><span class="p">:</span> <span class="n">md_mngr</span><span class="o">.</span><span class="n">translate_variables_by_table</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">md_mngr</span><span class="o">.</span><span class="n">map_tables_to_files</span><span class="p">(</span><span class="n">abs_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">merge_data</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="n">merge_dict</span><span class="p">,</span> <span class="n">concat_files</span><span class="o">=</span><span class="n">concat_files</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>paths: [code]</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
    
  </body>
</html>